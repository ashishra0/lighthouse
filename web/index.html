<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lighthouse — Network Discovery</title>
    <style>
      :root {
        --bg:           #060b12;
        --surface:      #0b1520;
        --surface2:     #0f1d2e;
        --border:       #152234;
        --border-hi:    #1e3a58;
        --text:         #7facc8;
        --text-dim:     #2e4d63;
        --text-bright:  #c8e4f8;
        --accent:       #0ea5e9;
        --accent-faint: rgba(14, 165, 233, 0.08);
        --accent-glow:  rgba(14, 165, 233, 0.25);
        --online:       #10b981;
        --online-faint: rgba(16, 185, 129, 0.12);
        --offline:      #1e293b;
        --mono: 'SF Mono', 'Cascadia Code', 'Fira Code', 'Consolas', 'Monaco', 'Courier New', monospace;
      }

      * { margin: 0; padding: 0; box-sizing: border-box; }

      html, body {
        height: 100%;
        overflow: hidden;
      }

      body {
        font-family: var(--mono);
        background: var(--bg);
        color: var(--text);
        display: flex;
        flex-direction: column;
      }

      /* ── Topbar ─────────────────────────────────────────── */
      .topbar {
        height: 44px;
        min-height: 44px;
        background: var(--surface);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        flex-shrink: 0;
      }

      .topbar-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .logo-mark {
        width: 22px;
        height: 22px;
        border: 1.5px solid var(--accent);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        flex-shrink: 0;
      }

      .logo-mark::after {
        content: '';
        width: 6px;
        height: 6px;
        background: var(--accent);
        border-radius: 50%;
        box-shadow: 0 0 8px var(--accent);
      }

      .topbar-title {
        font-size: 13px;
        font-weight: 700;
        letter-spacing: 3px;
        text-transform: uppercase;
        color: var(--text-bright);
      }

      .topbar-sep {
        color: var(--text-dim);
        font-size: 12px;
      }

      .topbar-sub {
        font-size: 10px;
        letter-spacing: 1.5px;
        text-transform: uppercase;
        color: var(--text-dim);
      }

      .topbar-right {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 10px;
        letter-spacing: 1px;
        text-transform: uppercase;
        color: var(--text-dim);
      }

      .pulse-dot {
        width: 7px;
        height: 7px;
        background: var(--online);
        border-radius: 50%;
        box-shadow: 0 0 8px var(--online);
        animation: pulse-anim 2.5s ease-in-out infinite;
      }

      @keyframes pulse-anim {
        0%, 100% { opacity: 1; }
        50%       { opacity: 0.3; box-shadow: none; }
      }

      /* ── Layout ─────────────────────────────────────────── */
      .layout {
        display: flex;
        flex: 1;
        overflow: hidden;
      }

      /* ── Sidebar ────────────────────────────────────────── */
      .sidebar {
        width: 240px;
        min-width: 240px;
        background: var(--surface);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }

      .sb-section {
        padding: 20px;
        border-bottom: 1px solid var(--border);
      }

      .sb-label {
        font-size: 9px;
        letter-spacing: 2.5px;
        text-transform: uppercase;
        color: var(--text-dim);
        margin-bottom: 16px;
      }

      /* Stats */
      .stat-item {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .stat-item:last-child { margin-bottom: 0; }

      .stat-name {
        font-size: 11px;
        color: var(--text-dim);
      }

      .stat-val {
        font-size: 24px;
        font-weight: 700;
        line-height: 1;
        color: var(--text-bright);
        letter-spacing: -0.5px;
      }

      .stat-val.v-online  { color: var(--online); }
      .stat-val.v-offline { color: #374151; }

      /* Networks in sidebar */
      .net-entry {
        margin-bottom: 14px;
      }

      .net-entry:last-child { margin-bottom: 0; }

      .net-cidr {
        font-size: 12px;
        color: var(--accent);
        margin-bottom: 3px;
      }

      .net-meta {
        font-size: 10px;
        color: var(--text-dim);
        line-height: 1.6;
      }

      .net-badge {
        display: inline-block;
        padding: 1px 6px;
        background: var(--online-faint);
        border: 1px solid rgba(16, 185, 129, 0.3);
        color: var(--online);
        font-size: 8px;
        letter-spacing: 1px;
        text-transform: uppercase;
        margin-top: 4px;
      }

      /* Sidebar footer */
      .sb-footer {
        margin-top: auto;
        padding: 18px 20px;
        border-top: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .toggle-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .toggle-label {
        font-size: 10px;
        letter-spacing: 1.5px;
        text-transform: uppercase;
        color: var(--text-dim);
      }

      .toggle { position: relative; width: 36px; height: 20px; cursor: pointer; }
      .toggle input { opacity: 0; width: 0; height: 0; }
      .toggle-slider {
        position: absolute; inset: 0;
        background: var(--border-hi); border-radius: 20px; transition: 0.2s;
        cursor: pointer;
      }
      .toggle-slider::before {
        content: ''; position: absolute;
        width: 14px; height: 14px; left: 3px; bottom: 3px;
        background: var(--text-dim); border-radius: 50%; transition: 0.2s;
      }
      .toggle input:checked + .toggle-slider { background: var(--online); }
      .toggle input:checked + .toggle-slider::before {
        transform: translateX(16px);
        background: #fff;
      }

      .refresh-btn {
        width: 100%;
        padding: 9px 12px;
        background: transparent;
        border: 1px solid var(--border-hi);
        color: var(--accent);
        font-family: var(--mono);
        font-size: 10px;
        letter-spacing: 1.5px;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.15s;
      }

      .refresh-btn:hover {
        background: var(--accent-faint);
        border-color: var(--accent);
        box-shadow: 0 0 12px var(--accent-glow);
      }

      /* ── Main content ───────────────────────────────────── */
      .main {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .content-header {
        padding: 16px 24px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 12px;
        flex-shrink: 0;
      }

      .ch-label {
        font-size: 9px;
        letter-spacing: 2.5px;
        text-transform: uppercase;
        color: var(--text-dim);
        white-space: nowrap;
      }

      .ch-line {
        flex: 1;
        height: 1px;
        background: var(--border);
      }

      .ch-count {
        font-size: 10px;
        color: var(--text-dim);
        letter-spacing: 1px;
        white-space: nowrap;
      }

      .content-body {
        flex: 1;
        overflow-y: auto;
        padding: 0;
      }

      /* ── Device Table ───────────────────────────────────── */
      table {
        width: 100%;
        border-collapse: collapse;
      }

      thead {
        position: sticky;
        top: 0;
        z-index: 1;
      }

      th {
        padding: 10px 16px;
        text-align: left;
        font-size: 9px;
        font-weight: 400;
        letter-spacing: 2px;
        text-transform: uppercase;
        color: var(--text-dim);
        background: var(--surface);
        border-bottom: 1px solid var(--border);
      }

      td {
        padding: 13px 16px;
        font-size: 12px;
        border-bottom: 1px solid var(--border);
        vertical-align: middle;
      }

      tbody tr:hover td {
        background: var(--surface2);
      }

      .status-cell {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
      }

      .dot.online {
        background: var(--online);
        box-shadow: 0 0 7px var(--online);
      }

      .dot.offline {
        background: transparent;
        border: 1.5px solid #2d3748;
      }

      .status-txt {
        font-size: 9px;
        letter-spacing: 1.5px;
        text-transform: uppercase;
      }

      .status-txt.online  { color: var(--online); }
      .status-txt.offline { color: var(--text-dim); }

      .ip-val {
        color: var(--accent);
        font-size: 12px;
      }

      .host-val {
        color: var(--text-bright);
        font-size: 12px;
      }

      .mac-val {
        color: var(--text-dim);
        font-size: 11px;
      }

      .vendor-val {
        color: #34d399;
        font-size: 11px;
      }

      .ts-val {
        font-size: 10px;
        color: var(--text-dim);
      }

      /* ── Loading / empty states ─────────────────────────── */
      .state-msg {
        padding: 64px 24px;
        text-align: center;
        font-size: 10px;
        letter-spacing: 2px;
        text-transform: uppercase;
        color: var(--text-dim);
      }

      /* ── Scrollbar ──────────────────────────────────────── */
      ::-webkit-scrollbar { width: 4px; height: 4px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: var(--border-hi); border-radius: 2px; }
    </style>
  </head>
  <body>
    <!-- Top bar -->
    <header class="topbar">
      <div class="topbar-left">
        <div class="logo-mark"></div>
        <span class="topbar-title">Lighthouse</span>
        <span class="topbar-sep">/</span>
        <span class="topbar-sub">Network Discovery</span>
      </div>
      <div class="topbar-right">
        <div class="pulse-dot"></div>
        <span id="lastUpdated">connecting</span>
      </div>
    </header>

    <!-- Body layout -->
    <div class="layout">
      <!-- Sidebar -->
      <aside class="sidebar">
        <!-- Stats -->
        <div class="sb-section">
          <div class="sb-label">Overview</div>
          <div class="stat-item">
            <span class="stat-name">Total</span>
            <span class="stat-val" id="totalDevices">—</span>
          </div>
          <div class="stat-item">
            <span class="stat-name">Online</span>
            <span class="stat-val v-online" id="onlineDevices">—</span>
          </div>
          <div class="stat-item">
            <span class="stat-name">Offline</span>
            <span class="stat-val v-offline" id="offlineDevices">—</span>
          </div>
          <div class="stat-item">
            <span class="stat-name">Networks</span>
            <span class="stat-val" id="networkCount">—</span>
          </div>
        </div>

        <!-- Networks -->
        <div class="sb-section">
          <div class="sb-label">Networks</div>
          <div id="networkList">
            <div class="net-meta">Loading...</div>
          </div>
        </div>

        <!-- Footer controls -->
        <div class="sb-footer">
          <div class="toggle-row">
            <span class="toggle-label">Auto-refresh</span>
            <label class="toggle">
              <input type="checkbox" id="autoRefresh" checked />
              <span class="toggle-slider"></span>
            </label>
          </div>
          <button class="refresh-btn" onclick="loadAllData()">↺ &nbsp;Refresh Now</button>
        </div>
      </aside>

      <!-- Main panel -->
      <main class="main">
        <div class="content-header">
          <span class="ch-label">Discovered Devices</span>
          <div class="ch-line"></div>
          <span class="ch-count" id="deviceCount"></span>
        </div>

        <div class="content-body">
          <div id="loading" class="state-msg">Scanning network...</div>

          <table id="deviceTable" style="display:none">
            <thead>
              <tr>
                <th>Status</th>
                <th>IP Address</th>
                <th>Hostname</th>
                <th>MAC Address</th>
                <th>Vendor</th>
                <th>Last Seen</th>
              </tr>
            </thead>
            <tbody id="deviceList"></tbody>
          </table>
        </div>
      </main>
    </div>

    <script>
      let autoRefreshEnabled = true;
      let refreshInterval;

      window.onload = function () {
        loadAllData();
        startAutoRefresh();

        document.getElementById("autoRefresh").addEventListener("change", function (e) {
          autoRefreshEnabled = e.target.checked;
          if (autoRefreshEnabled) {
            startAutoRefresh();
          } else {
            stopAutoRefresh();
          }
        });
      };

      function startAutoRefresh() {
        if (refreshInterval) clearInterval(refreshInterval);
        refreshInterval = setInterval(() => {
          if (autoRefreshEnabled) loadAllData();
        }, 30000);
      }

      function stopAutoRefresh() {
        if (refreshInterval) clearInterval(refreshInterval);
      }

      async function loadAllData() {
        await Promise.all([loadStats(), loadNetworks(), loadDevices()]);
        const now = new Date();
        document.getElementById("lastUpdated").textContent =
          "updated " + now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
      }

      async function loadStats() {
        try {
          const res = await fetch("/api/stats");
          const s = await res.json();
          document.getElementById("totalDevices").textContent = s.TotalDevices ?? 0;
          document.getElementById("onlineDevices").textContent = s.OnlineDevices ?? 0;
          document.getElementById("offlineDevices").textContent = s.OfflineDevices ?? 0;
        } catch (e) {
          console.error("stats:", e);
        }
      }

      async function loadNetworks() {
        try {
          const res = await fetch("/api/networks");
          const networks = await res.json();

          document.getElementById("networkCount").textContent = networks.length;

          const list = document.getElementById("networkList");
          list.innerHTML = "";

          if (networks.length === 0) {
            list.innerHTML = '<div class="net-meta">No networks detected</div>';
            return;
          }

          networks.forEach((net) => {
            const el = document.createElement("div");
            el.className = "net-entry";
            el.innerHTML = `
              <div class="net-cidr">${net.CIDR}</div>
              <div class="net-meta">${getNetworkName(net.Interface)} &bull; ${net.Interface}</div>
              <div class="net-meta">${net.IP}</div>
              <span class="net-badge">Active</span>
            `;
            list.appendChild(el);
          });
        } catch (e) {
          console.error("networks:", e);
        }
      }

      function getNetworkName(iface) {
        if (iface === "en0") return "Wi-Fi";
        if (iface.startsWith("utun")) return "VPN Tunnel";
        if (iface.startsWith("tailscale")) return "Tailscale";
        if (iface.startsWith("eth")) return "Ethernet";
        return iface;
      }

      async function loadDevices() {
        try {
          document.getElementById("loading").style.display = "block";
          document.getElementById("deviceTable").style.display = "none";

          const res = await fetch("/api/devices");
          const devices = await res.json();

          document.getElementById("loading").style.display = "none";

          if (devices.length === 0) {
            document.getElementById("deviceCount").textContent = "no devices";
            document.getElementById("loading").textContent = "No devices found — run a scan first.";
            document.getElementById("loading").style.display = "block";
            return;
          }

          document.getElementById("deviceCount").textContent =
            `${devices.length} device${devices.length !== 1 ? "s" : ""}`;

          renderDevices(devices);
        } catch (e) {
          console.error("devices:", e);
          document.getElementById("loading").style.display = "none";
        }
      }

      function renderDevices(devices) {
        const tbody = document.getElementById("deviceList");
        tbody.innerHTML = "";

        if (devices.length === 0) {
          document.getElementById("deviceTable").style.display = "none";
          return;
        }

        document.getElementById("deviceTable").style.display = "table";

        devices.forEach((d) => {
          const row = tbody.insertRow();
          const statusCls = d.IsOnline ? "online" : "offline";
          const statusTxt = d.IsOnline ? "Online" : "Offline";

          row.insertCell().innerHTML = `
            <div class="status-cell">
              <span class="dot ${statusCls}"></span>
              <span class="status-txt ${statusCls}">${statusTxt}</span>
            </div>`;

          const ip = row.insertCell();
          ip.className = "ip-val";
          ip.textContent = d.IP || "—";

          const host = row.insertCell();
          host.className = "host-val";
          host.textContent = d.Hostname || "—";

          const mac = row.insertCell();
          mac.className = "mac-val";
          mac.textContent = d.MAC || "—";

          const vendor = row.insertCell();
          vendor.className = "vendor-val";
          vendor.textContent = d.Vendor || "—";

          row.insertCell().innerHTML = formatDate(d.LastSeen);
        });
      }

      function formatDate(dateString) {
        if (!dateString) return '<span class="ts-val">—</span>';
        const date = new Date(dateString);
        const diffMins = Math.floor((Date.now() - date) / 60000);

        let label;
        if (diffMins < 1)         label = "just now";
        else if (diffMins < 60)   label = `${diffMins}m ago`;
        else if (diffMins < 1440) label = `${Math.floor(diffMins / 60)}h ago`;
        else                      label = `${Math.floor(diffMins / 1440)}d ago`;

        return `<span class="ts-val" title="${date.toLocaleString()}">${label}</span>`;
      }
    </script>
  </body>
</html>
